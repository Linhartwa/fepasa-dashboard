<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Certificación Operacional L2–L3</title>
<style>
body { font-family: Arial; background:#f4f6f9; margin:20px;}
h1 { text-align:center;}
.question {background:white;padding:15px;margin-bottom:10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
button{padding:10px 20px;font-size:16px;margin-top:20px;}
#timer{font-size:18px;font-weight:bold;color:#c0392b;}
</style>
</head>
<body>

<h1>Certificación Operacional Maniobras L2–L3</h1>
<p id="timer">Tiempo restante: 20:00</p>

<div class="question">
<label>Nombre:</label><br>
<input type="text" id="nombre"><br><br>

<label>RUT (12345678-9):</label><br>
<input type="text" id="rut"><br><br>

<label>Cargo:</label><br>
<input type="text" id="cargo"><br><br>

<label>Supervisor:</label><br>
<input type="text" id="supervisor">
</div>

<form id="quizForm"></form>

<button onclick="calcularResultado()">Finalizar Evaluación</button>
<div id="result"></div>

<script>

// ===== CONFIG =====
const API_URL = "PEGA_AQUI_TU_URL_APPS_SCRIPT";
const LIMITE_APROBACION = 80;

// ===== TEMPORIZADOR =====
let tiempo = 1200;
const timer = setInterval(()=>{
    tiempo--;
    let min = Math.floor(tiempo/60);
    let seg = tiempo%60;
    document.getElementById("timer").innerText =
        `Tiempo restante: ${min}:${seg<10?"0"+seg:seg}`;
    if(tiempo<=0){
        clearInterval(timer);
        alert("Tiempo agotado");
        calcularResultado();
    }
},1000);

// ===== VALIDACION RUT =====
function validarRut(rutCompleto){
    if(!/^[0-9]+-[0-9kK]{1}$/.test(rutCompleto)) return false;
    let tmp=rutCompleto.split('-');
    let digv=tmp[1].toLowerCase();
    let rut=tmp[0];
    return dv(rut)==digv;
}
function dv(T){
    let M=0,S=1;
    for(;T;T=Math.floor(T/10))
        S=(S+T%10*(9-M++%6))%11;
    return S?S-1:'k';
}

// ===== PREGUNTAS =====
const preguntas = [
{q:"¿Quién autoriza todas las rutas?",o:["COS","CCT MAPA","Supervisor","Reloncaví"],a:1},
{q:"Baliza encendida significa:",o:["Desconectado","Conectado","Vacío","Bloqueado"],a:1},
{q:"Subtrenada mínima:",o:["10","15","20","25"],a:2},
{q:"Velocidad romana:",o:["10","8","5","3"],a:2},
{q:"Máx carros D5:",o:["15","18","22","25"],a:2},
{q:"Prueba freno la ejecuta:",o:["CCT","MTTO","Maquinista","COS"],a:1},
{q:"Empuje protegido por:",o:["CCT","Ayudante caminando","Supervisor","COS"],a:1},
{q:"Plazo entrega guías:",o:["10","20","30","60"],a:2},
{q:"Locomotora 1800 empuje:",o:["Permitida","Prohibida","Solo L3","Solo doble"],a:1},
{q:"Cruce SALFA máximo bloqueo:",o:["5","3","2","10"],a:1}
];

// ALEATORIZAR
preguntas.sort(()=>Math.random()-0.5);

const form=document.getElementById("quizForm");
preguntas.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="question";
    div.innerHTML=`<p>${i+1}. ${p.q}</p>`+
    p.o.map((opt,j)=>`<label><input type="radio" name="q${i}" value="${j}"> ${opt}</label><br>`).join("");
    form.appendChild(div);
});

// ===== RESULTADO =====
function calcularResultado(){

let nombre=document.getElementById("nombre").value;
let rut=document.getElementById("rut").value;
let cargo=document.getElementById("cargo").value;
let supervisor=document.getElementById("supervisor").value;

if(!nombre||!rut||!cargo||!supervisor){
    alert("Complete todos los datos");
    return;
}
if(!validarRut(rut)){
    alert("RUT inválido");
    return;
}

let puntaje=0;
preguntas.forEach((p,i)=>{
    let r=document.querySelector(`input[name="q${i}"]:checked`);
    if(r && parseInt(r.value)===p.a) puntaje+=10;
});

let estado=puntaje>=LIMITE_APROBACION?"APROBADO":"REPROBADO";

fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
        nombre:nombre,
        rut:rut,
        cargo:cargo,
        supervisor:supervisor,
        puntaje:puntaje,
        tiempo:1200-tiempo
    })
}).then(r=>r.text()).then(res=>{
    if(res==="LIMITE"){
        alert("Máximo 3 intentos por día alcanzado");
        return;
    }
});

document.getElementById("result").innerHTML=
`<h2>Puntaje: ${puntaje}/100 - ${estado}</h2>`;

if(estado==="APROBADO"){
    generarCertificado(nombre,rut,puntaje);
}
}

// ===== CERTIFICADO =====
function generarCertificado(nombre,rut,puntaje){
    let contenido=
`CERTIFICADO OFICIAL
Certifica que ${nombre}
RUT: ${rut}
Ha aprobado Evaluación Operacional L2-L3
Puntaje: ${puntaje}/100
Fecha: ${new Date().toLocaleDateString()}
`;
    let blob=new Blob([contenido],{type:"application/pdf"});
    let link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="Certificado_L2-L3.pdf";
    link.click();
}

</script>
</body>
</html>

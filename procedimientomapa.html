<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Certificación Operacional FEPASA L2–L3</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f4f6f9;
}
.header {
    background: #003A70;
    color: white;
    padding: 20px;
    text-align: center;
}
.logo {
    height: 60px;
}
.container {
    padding: 20px;
}
.question {
    background: white;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
button {
    background:#003A70;
    color:white;
    padding:10px 20px;
    border:none;
    font-size:16px;
    cursor:pointer;
    border-radius:5px;
}
button:hover {
    background:#002850;
}
#timer {
    font-size: 18px;
    font-weight: bold;
    color: #c0392b;
}
#result {
    margin-top:20px;
    font-size:22px;
    font-weight:bold;
}
</style>
</head>
<body>

<div class="header">
    <img src="logo-fepasa.png" class="logo"><br>
    <h2>Certificación Operacional Maniobras L2–L3</h2>
</div>

<div class="container">

<p id="timer">Tiempo restante: 60:00</p>

<div class="question">
<label>Nombre:</label><br>
<input type="text" id="nombre"><br><br>

<label>RUT (12345678-9):</label><br>
<input type="text" id="rut"><br><br>

<label>Cargo:</label><br>
<input type="text" id="cargo"><br><br>

<label>Supervisor:</label><br>
<input type="text" id="supervisor">
</div>

<form id="quizForm"></form>

<button onclick="calcularResultado()">Finalizar Evaluación</button>
<div id="result"></div>

</div>

<script>

// ===== CONFIGURACIÓN =====
const API_URL = "PEGA_AQUI_TU_URL_APPS_SCRIPT";
const LIMITE_APROBACION = 80;

// ===== TEMPORIZADOR 60 MIN =====
let tiempo = 3600;
const timer = setInterval(()=>{
    tiempo--;
    let min = Math.floor(tiempo/60);
    let seg = tiempo%60;
    document.getElementById("timer").innerText =
        `Tiempo restante: ${min}:${seg<10?"0"+seg:seg}`;
    if(tiempo<=0){
        clearInterval(timer);
        alert("Tiempo agotado");
        calcularResultado();
    }
},1000);

// ===== VALIDACIÓN RUT =====
function validarRut(rutCompleto){
    if(!/^[0-9]+-[0-9kK]{1}$/.test(rutCompleto)) return false;
    let tmp=rutCompleto.split('-');
    let digv=tmp[1].toLowerCase();
    let rut=tmp[0];
    return dv(rut)==digv;
}
function dv(T){
    let M=0,S=1;
    for(;T;T=Math.floor(T/10))
        S=(S+T%10*(9-M++%6))%11;
    return S?S-1:'k';
}

// ===== 50 PREGUNTAS COMPLETAS =====
const preguntas = [
{q:"¿Quién autoriza todas las rutas dentro de Planta?",o:["COS L3","Supervisor Patio","CCT MAPA","Jefe Serfocol"],a:2},
{q:"La gobernanza del CCT MAPA inicia en:",o:["DVR1032","DVR1001","DVR801B","DVR1036"],a:1},
{q:"Función principal del COS L3:",o:["Autorizar rutas","Apertura portones","Prueba freno","Armado tren"],a:1},
{q:"LM significa:",o:["Línea Mayor","Límite Maniobra","Línea Madera","Límite Mecánico"],a:1},
{q:"Máx bloqueo cruce SALFA:",o:["5 min","3 min","2 min","10 min"],a:1},
{q:"Baliza roja Sendero la instala:",o:["Tripulación","CCT","Mantenimiento","COS"],a:2},
{q:"Primera fracción vacíos se revisa:",o:["Apertura total","Visual sin abrir","Desmontaje","Desde cabina"],a:1},
{q:"Carros rechazados L3 van a:",o:["BPT","VPC","VAQ","VTV"],a:2},
{q:"Responsable carguío BPT L3:",o:["Tripulación","CCT","Reloncaví","MTTO"],a:2},
{q:"Máx carros ingreso BPT L2:",o:["10","15","5","20"],a:2},
{q:"BPT Pacífico requiere:",o:["Ingreso libre","Carro protección","Volanda","Desacople externo"],a:1},
{q:"Subtrenada mínima:",o:["10","15","20","25"],a:2},
{q:"Empuje L3→L2 inicia en:",o:["DVR1001","DVR801 A/B","DVR1021","DVR1032"],a:1},
{q:"Protección empuje:",o:["CCT","Ayudante caminando","Supervisor","COS"],a:1},
{q:"Prueba freno la ejecuta:",o:["Maquinista","CCT","Mantenimiento","Serfocol"],a:2},
{q:"Velocidad romana:",o:["10","8","5","3"],a:2},
{q:"Baliza encendida:",o:["Desconectado","Conectado","Vacío","Bloqueado"],a:1},
{q:"Detector obligatorio química:",o:["CO2","H2S y ClO2","Metano","Oxígeno"],a:1},
{q:"Máx carros D5 forestal:",o:["15","18","22","25"],a:2},
{q:"Excedentes forestal se dejan en:",o:["VPC","VSC","D4","801B"],a:2},
{q:"Locomotora 1800 empuje:",o:["Permitida","Prohibida","Solo L3","Solo doble"],a:1},
{q:"Doble tracción requiere:",o:["Sin radio","Coordinación radial","Solo empuje","Sin freno"],a:1},
{q:"Distancia mínima fraccionamiento:",o:["1m","1.5m","2m","3m"],a:2},
{q:"Pisadera en empuje:",o:["Permitido","Prohibido","Solo L3","Solo L2"],a:1},
{q:"Plazo entrega guías:",o:["10","20","30","60"],a:2},
{q:"Doc químicos incluye:",o:["Solo guía","Guía+Check","Guía+Check+HDS","Solo HDS"],a:2},
{q:"Cruce no bloquear más de:",o:["5 min","3 min","2 min","10 min"],a:1},
{q:"Uso celular zona:",o:["Libre","Solo redes","Solo coordinaciones","Prohibido total"],a:2},
{q:"Comer en química:",o:["Permitido","Prohibido","Solo cabina","Descanso"],a:1},
{q:"Limpieza forestal estándar:",o:["Riel visible","Durmiente visible","Balasto visible","Cambio limpio"],a:1},
{q:"Equipo estacionado debe quedar:",o:["Solo calza","Solo freno","Freno+calza+sin aire","Con loco"],a:2},
{q:"Cruzarse sobre acoples:",o:["Permitido","Solo vacío","Prohibido","Con autorización"],a:2},
{q:"Reparaciones en planta:",o:["Permitidas","Menores","Prohibidas","Solo L3"],a:2},
{q:"Baliza apagada significa:",o:["Conectado","Desconectado","Bloqueado","Rechazado"],a:1},
{q:"Postura química L3:",o:["2 sodas","4 sodas 1 clorato","3 sodas","5 cloratos"],a:1},
{q:"Área petróleo verificar:",o:["Pintura","Camiones","Peso","Estiba"],a:1},
{q:"Carros petróleo no deben tener:",o:["Óxido","Abolladuras","Goteo","Cortinas abiertas"],a:2},
{q:"Salida ruta desde:",o:["DVR801","DVR1032→1001","DVR1036","DVR1021"],a:1},
{q:"Si no entiende instrucción:",o:["Ejecutar","Confirmar","Esperar","Delegar"],a:1},
{q:"Carros armados quedan:",o:["Solo freno","Sin aire","Freno+calza+sin aire","Con loco"],a:2},
{q:"Protección última pieza:",o:["CCT","Ayudante","Supervisor","COS"],a:1},
{q:"Sendero es sector de:",o:["Carga","Revisión","Descarga","Romana"],a:1},
{q:"Armado mínimo L2:",o:["15","18","20","25"],a:2},
{q:"Ruta salida incluye:",o:["1005","1001","801B","1021"],a:1},
{q:"Tiempo evaluación:",o:["30","45","60","90"],a:2},
{q:"Aprobación mínima:",o:["70","75","80","85"],a:2},
{q:"Baliza manipula:",o:["Tripulación","CCT","Operador área","Supervisor"],a:2},
{q:"Empuje debe ser:",o:["Libre","Protegido caminando","Vehículo","Radial"],a:1},
{q:"Gobernanza interna:",o:["COS","CCT MAPA","Supervisor","Reloncaví"],a:1}
];

// Aleatorizar
preguntas.sort(()=>Math.random()-0.5);

const form=document.getElementById("quizForm");
preguntas.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="question";
    div.innerHTML=`<p>${i+1}. ${p.q}</p>`+
    p.o.map((opt,j)=>`<label><input type="radio" name="q${i}" value="${j}"> ${opt}</label><br>`).join("");
    form.appendChild(div);
});

// Resultado
function calcularResultado(){

let nombre=document.getElementById("nombre").value;
let rut=document.getElementById("rut").value;
let cargo=document.getElementById("cargo").value;
let supervisor=document.getElementById("supervisor").value;

if(!nombre||!rut||!cargo||!supervisor){
alert("Complete todos los datos");
return;
}
if(!validarRut(rut)){
alert("RUT inválido");
return;
}

let puntaje=0;
preguntas.forEach((p,i)=>{
let r=document.querySelector(`input[name="q${i}"]:checked`);
if(r && parseInt(r.value)===p.a) puntaje+=2;
});

let estado=puntaje>=LIMITE_APROBACION?"APROBADO":"REPROBADO";

fetch(API_URL,{
method:"POST",
body:JSON.stringify({
nombre:nombre,
rut:rut,
cargo:cargo,
supervisor:supervisor,
puntaje:puntaje,
tiempo:3600-tiempo
})
});

document.getElementById("result").innerHTML=
`Puntaje: ${puntaje}/100 - ${estado}`;

if(estado==="APROBADO"){
let contenido=`CERTIFICADO OFICIAL FEPASA
${nombre}
RUT: ${rut}
Aprobó Certificación Maniobras L2-L3
Puntaje: ${puntaje}/100
Fecha: ${new Date().toLocaleDateString()}`;
let blob=new Blob([contenido],{type:"application/pdf"});
let link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="Certificado_FEPASA_L2L3.pdf";
link.click();
}
}

</script>
</body>
</html>

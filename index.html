<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Operacional - FEPASA</title>

  <!-- Estilos -->
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background-color: #f4f6fa;
      color: #002b5c;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    header img {
      height: 50px;
    }
    h1 {
      font-size: 1.6em;
      margin: 0;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      margin: 20px;
      gap: 20px;
    }
    .chart-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      flex: 1 1 45%;
      min-width: 350px;
    }
    canvas {
      width: 100% !important;
      height: 360px !important;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    th {
      background: #003366;
      color: white;
      padding: 10px;
    }
    td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .summary {
      background: #f0f3fa;
      font-weight: bold;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header>
    <img src="https://www.fepasa.com/wp-content/uploads/2023/03/LOGO-FEPASA-VECTORIAL-1.png" alt="FEPASA Logo">
    <h1>Dashboard Operacional – FEPASA</h1>
  </header>

  <div class="container">
    <div class="chart-card">
      <h2>Tasa de Carga por Subtrenada</h2>
      <canvas id="graficoTasa"></canvas>
    </div>

    <div class="chart-card">
      <h2>Tiempos de Proceso</h2>
      <canvas id="graficoTiempos"></canvas>
    </div>
  </div>

  <table id="tablaResumen">
    <thead>
      <tr>
        <th>SUBTRENADA</th>
        <th>LINEA</th>
        <th>POSTURA</th>
        <th>AVISO</th>
        <th>RETIRO</th>
        <th>CARROS CARGADOS</th>
        <th>TIEMPO DE CARGA (min)</th>
        <th>AVISO - RETIRO (min)</th>
        <th>RETIRO - POSTURA (min)</th>
        <th>TASA DE CARGA</th>
        <th>EFICIENCIA (%)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <table id="tablaTotales">
    <thead>
      <tr>
        <th colspan="11" style="background:#003366;color:white;">Resumen del tren</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const params = new URLSearchParams(window.location.search);
    const tren = params.get("tren") || "N/D";
    const subtrenadas = params.get("subtrenadas")?.split(",") || [];
    const linea = params.get("linea")?.split(",") || [];
    const postura = params.get("postura")?.split(",") || [];
    const aviso = params.get("aviso")?.split(",") || [];
    const retiro = params.get("retiro")?.split(",") || [];
    const cargados = (params.get("cargados")?.split(",") || []).map(Number);
    const tiempoCarga = (params.get("tiempoCarga")?.split(",") || []).map(Number);
    const avisoRetiro = (params.get("avisoRetiro")?.split(",") || []).map(Number);
    const avisoPostura = (params.get("avisoPostura")?.split(",") || []).map(Number);
    const tasaCarga = (params.get("tasaCarga")?.split(",") || []).map(Number);
    const eficiencia = (params.get("eficiencia")?.split(",") || []).map(Number);

    const promedio = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : 0;
    const total = (arr) => arr.length ? arr.reduce((a,b)=>a+b,0) : 0;

    // === GRÁFICO TASA ===
    new Chart(document.getElementById("graficoTasa"), {
      type: "bar",
      data: {
        labels: subtrenadas,
        datasets: [
          {
            label: "Tasa de Carga (car/h)",
            data: tasaCarga,
            backgroundColor: "#007bff"
          },
          {
            label: "Eficiencia (%)",
            data: eficiencia,
            backgroundColor: "#ffc107"
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: { mode: "index" },
          datalabels: {
            anchor: 'end', align: 'start', color: '#000'
          }
        },
        scales: {
          x: { title: { display: true, text: "Subtrenada Planificada" } },
          y: { title: { display: true, text: "Valor" }, beginAtZero: true }
        }
      }
    });

    // === GRÁFICO TIEMPOS ===
    new Chart(document.getElementById("graficoTiempos"), {
      type: "bar",
      data: {
        labels: subtrenadas,
        datasets: [
          { label: "Aviso - Retiro (min)", data: avisoRetiro, backgroundColor: "#6f42c1" },
          { label: "Retiro - Postura (min)", data: avisoPostura, backgroundColor: "#20c997" }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } },
        scales: {
          x: { title: { display: true, text: "Subtrenada Planificada" } },
          y: { title: { display: true, text: "Tiempo (min)" }, beginAtZero: true }
        }
      }
    });

    // === TABLA PRINCIPAL ===
    const tbody = document.querySelector("#tablaResumen tbody");
    subtrenadas.forEach((st, i) => {
      const fila = `
        <tr>
          <td>${st}</td>
          <td>${linea[i] || ""}</td>
          <td>${postura[i] || ""}</td>
          <td>${aviso[i] || ""}</td>
          <td>${retiro[i] || ""}</td>
          <td>${cargados[i] || 0}</td>
          <td>${tiempoCarga[i] || 0}</td>
          <td>${avisoRetiro[i] || 0}</td>
          <td>${avisoPostura[i] || 0}</td>
          <td>${tasaCarga[i] || 0}</td>
          <td>${eficiencia[i] || 0}</td>
        </tr>`;
      tbody.innerHTML += fila;
    });

    // === TABLA RESUMEN ===
    const ttot = document.querySelector("#tablaTotales tbody");
    ttot.innerHTML = `
      <tr class="summary">
        <td colspan="2">Tren ${tren}</td>
        <td colspan="3">Total Carros: ${total(cargados)}</td>
        <td colspan="3">Promedio Tasa Carga: ${promedio(tasaCarga)}</td>
        <td colspan="3">Promedio Eficiencia: ${promedio(eficiencia)}%</td>
      </tr>
    `;
  </script>
</body>
</html>


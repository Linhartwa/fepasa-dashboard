<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Operacional - FEPASA</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 0;
      color: #222;
    }

    header {
      background: #0a3871;
      color: white;
      margin: 0;
      padding: 0;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 0;
    }

    .header-content img {
      height: 45px;
    }

    .header-content h1 {
      font-size: 1.4em;
      font-weight: bold;
      margin: 0;
    }

    .blue-line {
      height: 5px;
      background: #003366;
      width: 100%;
    }

    .dashboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin: 25px auto;
      width: 95%;
      max-width: 1300px;
    }

    .chart-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      flex: 1 1 560px;
      max-width: 600px;
    }

    h2 {
      text-align: center;
      color: #0a3871;
      margin-bottom: 15px;
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
    }

    section.table-section {
      margin: 25px auto;
      width: 95%;
      max-width: 1200px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      padding: 25px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85em;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      margin-top: 15px;
    }

    table thead {
      background: #0a3871;
      color: white;
    }

    th, td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }

    tr:hover {
      background-color: #f1f6ff;
    }

    .resumen-kpi {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-top: 25px;
      background: #eaf1ff;
      border: 1px solid #bcd0ff;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }

    .kpi-box {
      flex: 1;
      color: #0a3871;
      font-weight: bold;
    }

    .kpi-box canvas {
      width: 100px !important;
      height: 100px !important;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <img src="https://www.fepasa.com/wp-content/uploads/2023/03/LOGO-FEPASA-VECTORIAL-1.png" alt="Logo FEPASA">
      <h1>Dashboard Operacional ‚Äì FEPASA</h1>
    </div>
    <div class="blue-line"></div>
  </header>

  <div class="dashboard">
    <div class="chart-card">
      <h2>Tasa de Carga</h2>
      <canvas id="graficoTasa"></canvas>
    </div>

    <div class="chart-card">
      <h2>Tiempos de Proceso (min)</h2>
      <canvas id="graficoTiempo"></canvas>
    </div>
  </div>

  <section class="table-section">
    <h2>An√°lisis de Carga ‚Äì Tren <span id="nombreTren"></span></h2>
    <div id="tablaResumen"></div>

    <div class="resumen-kpi">
      <div class="kpi-box">
        üöõ<br/>Total Carros Cargados<br/>
        <span id="totalCarros" style="font-size:1.4em"></span>
      </div>
      <div class="kpi-box">
        ‚öôÔ∏è<br/>Promedio Tasa de Carga<br/>
        <span id="promTasa" style="font-size:1.4em"></span>
      </div>
      <div class="kpi-box">
        üéØ<br/>Eficiencia Promedio<br/>
        <canvas id="graficoKPI"></canvas>
        <span id="promEficiencia" style="font-size:1.2em"></span>
      </div>
    </div>
  </section>

  <script>
    const params = new URLSearchParams(window.location.search);
    const tren = params.get("tren") || "-";
    const subtrenadas = params.get("subtrenadas")?.split(",") || [];
    const linea = params.get("linea")?.split(",") || [];
    const postura = params.get("postura")?.split(",") || [];
    const aviso = params.get("aviso")?.split(",") || [];
    const retiro = params.get("retiro")?.split(",") || [];
    const cargados = params.get("cargados")?.split(",").map(Number) || [];
    const tiempoCarga = params.get("tiempoCarga")?.split(",").map(Number) || [];
    const avisoRetiro = params.get("avisoRetiro")?.split(",").map(Number) || [];
    const avisoPostura = params.get("avisoPostura")?.split(",").map(Number) || [];
    const tasaCarga = params.get("tasaCarga")?.split(",").map(Number) || [];
    const eficiencia = params.get("eficiencia")?.split(",").map(Number) || [];

    document.getElementById("nombreTren").innerText = tren;

    const promedio = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    const total = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) : 0;

    // === GRAFICO TASA ===
    const ctx1 = document.getElementById("graficoTasa").getContext("2d");
    new Chart(ctx1, {
      type: "bar",
      data: {
        labels: subtrenadas,
        datasets: [
          { label: "Tasa de Carga (car/h)", data: tasaCarga, backgroundColor: "#007bff" },
          { label: "Eficiencia (%)", data: eficiencia, backgroundColor: "#ffc107" },
        ],
      },
      options: {
        plugins: {
          legend: { position: "bottom" },
          datalabels: {
            color: "black",
            anchor: "end",
            align: "top",
            formatter: (v) => v.toFixed(1),
          },
        },
        scales: {
          x: { title: { display: true, text: "Subtrenada Planificada" } },
          y: { beginAtZero: true, title: { display: true, text: "Valor" } },
        },
      },
      plugins: [ChartDataLabels],
    });

    // === GRAFICO TIEMPOS ===
    const ctx2 = document.getElementById("graficoTiempo").getContext("2d");
    new Chart(ctx2, {
      type: "bar",
      data: {
        labels: subtrenadas,
        datasets: [
          { label: "Aviso - Retiro (min)", data: avisoRetiro, backgroundColor: "#0dcaf0" },
          { label: "Retiro - Postura (min)", data: avisoPostura, backgroundColor: "#6610f2" },
        ],
      },
      options: {
        plugins: {
          legend: { position: "bottom" },
          datalabels: {
            color: "white",
            anchor: "center",
            align: "center",
            font: { weight: "bold" },
            formatter: (v) => v.toFixed(0),
          },
        },
        scales: {
          x: { title: { display: true, text: "Subtrenada Planificada" } },
          y: { beginAtZero: true, title: { display: true, text: "Minutos" } },
        },
      },
      plugins: [ChartDataLabels],
    });

    // === TABLA PRINCIPAL ===
    let html = `<table><thead><tr>
      <th>Subtrenada</th><th>L√≠nea</th><th>Postura</th><th>Aviso</th><th>Retiro</th>
      <th>Carros Cargados</th><th>Tiempo Carga (min)</th>
      <th>Aviso-Retiro (min)</th><th>Aviso-Postura (min)</th>
      <th>Tasa Carga (car/h)</th><th>Eficiencia (%)</th>
    </tr></thead><tbody>`;
    for (let i = 0; i < subtrenadas.length; i++) {
      html += `<tr>
        <td>${subtrenadas[i] || "-"}</td>
        <td>${linea[i] || "-"}</td>
        <td>${postura[i] || "-"}</td>
        <td>${aviso[i] || "-"}</td>
        <td>${retiro[i] || "-"}</td>
        <td>${cargados[i] || "-"}</td>
        <td>${tiempoCarga[i]?.toFixed(0) || "-"}</td>
        <td>${avisoRetiro[i]?.toFixed(0) || "-"}</td>
        <td>${avisoPostura[i]?.toFixed(0) || "-"}</td>
        <td>${tasaCarga[i]?.toFixed(2) || "-"}</td>
        <td>${eficiencia[i]?.toFixed(1) || "-"}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    document.getElementById("tablaResumen").innerHTML = html;

    // === KPI CIRCULAR ===
    const totalCarros = total(cargados);
    const promTasa = promedio(tasaCarga);
    const promEficiencia = promedio(eficiencia);

    document.getElementById("totalCarros").innerText = totalCarros;
    document.getElementById("promTasa").innerText = promTasa.toFixed(2) + " car/h";
    document.getElementById("promEficiencia").innerText = promEficiencia.toFixed(1) + "%";

    // Color din√°mico del KPI
    let colorKPI = "#198754"; // verde
    if (promEficiencia < 70) colorKPI = "#dc3545"; // rojo
    else if (promEficiencia < 90) colorKPI = "#ffc107"; // amarillo

    const ctxKPI = document.getElementById("graficoKPI").getContext("2d");
    new Chart(ctxKPI, {
      type: "doughnut",
      data: {
        datasets: [{
          data: [promEficiencia, 100 - promEficiencia],
          backgroundColor: [colorKPI, "#e0e0e0"],
          borderWidth: 0,
        }],
      },
      options: {
        cutout: "75%",
        plugins: { tooltip: { enabled: false } },
   

